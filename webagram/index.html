<!doctype html>
<!--
Copyright 2013 The Polymer Authors. All rights reserved.
Use of this source code is governed by a BSD-style
license that can be found in the LICENSE file.
-->
<html>

<head>
  <title>GIFit</title>
  <script src="https://www.google.com/jsapi"></script>

  
  <!-- pull in polymer -->
  <script src="scripts/polymer-all/polymer/polymer.js"></script>

<script src="scripts/gif.js"></script>
<script src="scripts/gif.worker.js"></script>

  <!-- import elements -->
  <link rel="import" href="scripts/polymer-all/polymer-elements/polymer-view-source-link/polymer-view-source-link.html">
  <link rel="import" href="scripts/polymer-all/polymer-elements/polymer-page/polymer-page.html">
  <link rel="import" href="scripts/polymer-all/polymer-elements/polymer-layout/polymer-layout.html">
  <link rel="import" href="scripts/polymer-all/polymer-elements/polymer-layout/polymer-slide.html">
  <link rel="import" href="scripts/polymer-all/polymer-ui-elements/polymer-ui-toolbar/polymer-ui-toolbar.html">
  <link rel="import" href="scripts/polymer-all/polymer-ui-elements/polymer-ui-icon-button/polymer-ui-icon-button.html">
  <link rel="import" href="scripts/polymer-all/polymer-ui-elements/polymer-ui-menu/polymer-ui-menu.html">
  <link rel="import" href="scripts/polymer-all/polymer-ui-elements/polymer-ui-menu-item/polymer-ui-menu-item.html">
  <link rel="import" href="scripts/polymer-all/projects/pica/components/pi-feed-aggregator.html"/>
  <link rel="import" href="scripts/polymer-all/projects/pica/components/pi-items-view.html"/>

  <!-- regular styling -->
  <link rel="stylesheet" href="scripts/polymer-all/polymer-ui-elements/basic.css">
  <link rel="stylesheet" href="src/css/index.css">
</head>

<body class="polymer-ui-body-text polymer-ui-dark-bg" theme="polymer-ui-dark-theme">

  <!-- just an element, this one makes document.body fit the viewport -->
  <polymer-page fullbleed></polymer-page>

  <!-- just an element, arranges sibling elements to fit their container -->
  <polymer-layout vertical></polymer-layout>


  <section class="splash" fit>
    <div class="logo">
      <img src="src/images/camera.png"/>
      <p>GIFit</p>
    </div>
  </section>

  <section fit>
    <polymer-layout></polymer-layout>

    <section class="sidebar polymer-ui-dark-bg">
      <polymer-slide id="slide" closed></polymer-slide>
      <polymer-layout vertical></polymer-layout>

      <section class="logo">
        <img src="src/images/camera.png"> GIFit
      </section>

      <!-- look-n-feel elements (aka widgets) -->
      <polymer-ui-menu fit>
        <polymer-ui-menu-item icon="dialog"><a href="../2. Not Just Widgets/">Settings</a></polymer-ui-menu-item>
      </polymer-ui-menu>
    </section>

    <section fit>
      <polymer-layout vertical></polymer-layout>

      <!-- look-n-feel elements (aka widgets) -->
      <polymer-ui-toolbar>
        <polymer-ui-icon-button icon="drawer" onclick="document.querySelector('#slide').toggle()"></polymer-ui-icon-button>
        <span id="header-title" fit>&nbsp;Activity</span>
      </polymer-ui-toolbar>
  

      <section fit class="main polymer-ui-light-bg">
        
        <!-- grid view -->
        <section id="activity" class="panel activity">
          <pi-items-view view="topics" layout="grid"></pi-items-view>
        </section>

        <!--capture view-->
        <section id="capture" class="panel capture">
          <p>Record a new animated GIF</p>
  
          <div class="preview">
            <video id="video" autoplay></video>
            <canvas id="canvas"></canvas>
          </div>


          <polymer-ui-toolbar class="main polymer-ui-light-bg" theme="polymer-ui-light-theme">
            <polymer-ui-icon-button src="src/images/media_record.png" onclick="recordVideo()"></polymer-ui-icon-button>
            <polymer-ui-icon-button src="src/images/stop.png" onclick="stopRec()"></polymer-ui-icon-button>
            <polymer-ui-icon-button src="src/images/play.png" onclick="replayVideo()"></polymer-ui-icon-button>
            <polymer-ui-icon-button src="src/images/save.png" onclick="makeGif()"></polymer-ui-icon-button>
            <polymer-ui-icon-button src="src/images/delete.png" onclick="deleteReplay()"></polymer-ui-icon-button>
            <polymer-ui-icon-button src="src/images/delete.png" onclick="playLast()"></polymer-ui-icon-button>
          </polymer-ui-toolbar>

<!--
          <div class="replay">
            <img width=360 height=240 src="" id="replay-screen">
          </div>
        -->
        </section>


          <section class="panel replay" id="replay">
            <img width=360 height=240 src="" id="replay-screen">
        <polymer-ui-toolbar class="main polymer-ui-light-bg" theme="polymer-ui-light-theme">
            <polymer-ui-icon-button src="src/images/save.png" onclick="makeGif()"></polymer-ui-icon-button>
          </polymer-ui-toolbar>
          </section>

          <section class="panel finalgif" id="finalgif">
            <p>Hold-down or right-click to save!</p>
          </section>

        <!--settings-->
        <section id="settings" class="panel settings">

          <div class="header item">Encoder</div>
          <div class="item no-border">
            <div class="item-input-label">Quality: </div>
            <input id="feed" type="url" class="flex" operation="addFeed" on-keyup="keyupHandler" value="10"/>
            <g-icon-button src="../images/add.png" on-tap="addFeed"></g-icon-button>
          </div>

        </section>


      </section>

      <polymer-ui-toolbar>
        <polymer-ui-icon-button src="src/images/toolbar_activity.png" onclick="switchPanel('activity', 'Activity')"></polymer-ui-icon-button>
        <polymer-ui-icon-button src="src/images/toolbar_camera.png" onclick="switchPanel('capture', 'Capture')"></polymer-ui-icon-button>
        <polymer-ui-icon-button src="src/images/toolbar_settings.png" onclick="switchPanel('settings', 'Settings')"></polymer-ui-icon-button>
      </polymer-ui-toolbar>

    </section>

  <script>

window.webagram = {
  localMediaStream: null,
  fs: null,
  error: null,
  _stop: false,
  _files: [],
  frameimages: []
};

var frames = 0;

window.webagram.gif = new GIF({
    workers: 4,
    quality: 10,
    delay: 500,
    repeat: 0
  });


navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;


function switchPanel(label, titleStr){
   var panels = document.querySelectorAll('.panel');
   var title = document.querySelector('#header-title');

   title.innerHTML = '&nbsp;' + titleStr;

   for(var i=0; i<panels.length;i++){
      el = panels[i];
      el.style.display = 'none';

      if(el.className === 'panel ' + label){
        el.style.display = 'block';
      }
   }    
}


function errorHandler(err){
  window.webagram.error =1 ;
  var msg = 'An error occured: ';
 
  switch (err.code) {
    case FileError.NOT_FOUND_ERR:
      msg += 'File or directory not found';
      break;
 
    case FileError.NOT_READABLE_ERR:
      msg += 'File or directory not readable';
      break;
 
    case FileError.PATH_EXISTS_ERR:
      msg += 'File or directory already exists';
      break;
 
    case FileError.TYPE_MISMATCH_ERR:
      msg += 'Invalid filetype';
      break;
 
    default:
      msg += 'Unknown Error';
      break;
  }
 
 console.log(msg);
}

var stopRec = function() {
  window.webagram.video.pause();
  if(window.webagram.localMediaStream)
    window.webagram.localMediaStream.stop();
  window.webagram._stop = 1;
};


var initDirectory = function(fs) {
  fs.root.getDirectory('Video', {create: true}, function(dirEntry) {
    console.log('You have just created the ' + dirEntry.name + ' directory.');

    fs.root.getDirectory('Video', {}, function(dirEntry){
      var dirReader = dirEntry.createReader();
      dirReader.readEntries(function(entries) {
      for(var i = 0; i < entries.length; i++) {
        var entry = entries[i];
          if (entry.isDirectory){
            console.log('Directory: ' + entry.fullPath);
          }
          else if (entry.isFile){
          console.log('File: ' + entry.fullPath);
          // remove comment to delete all files
          window.webagram._files.push(entry.fullPath);
          frames = parseInt(entry.fullPath[entry.fullPath.length-1], 10);

          if(frames === NaN || frames === 'NaN'){
            frames = 0;
          }

          console.log('init', frames, typeof frames);

        }
      }
    
      }, errorHandler);
    }, errorHandler);
  }, errorHandler);
};

var deleteReplay = function() {
    window.webagram.fs.root.getDirectory('Video', {}, function(dirEntry){
      var dirReader = dirEntry.createReader();
        dirReader.readEntries(function(entries) {
      if(!entries.length) alert('nothing to delete');
      for(var i = 0; i < entries.length; i++) {
        var entry = entries[i];
        if (entry.isFile){
          window.webagram.fs.root.getFile(entry.fullPath, {create: false}, function(fileEntry) {
          fileEntry.remove(function() {
          console.log('File successufully removed.');
          }, errorHandler);
        }, errorHandler);
      }
      }
    
      }, errorHandler);
    }, errorHandler);
};


var writeToFile = function(name, data) {

  window.webagram.fs.root.getFile('Video/' + name, {create: true, exclusive: true}, function(fileEntry) {
    console.log('A file ' + fileEntry.name + ' was created successfully.');
      window.webagram.fs.root.getFile('Video/' + fileEntry.name, {create: false}, function(fileEntry) {
      fileEntry.createWriter(function(fileWriter) {
        console.log('writing to ' + 'Video/' + fileEntry.name);
        window.webagram._files.push('Video/' + fileEntry.name);
        window.URL = window.URL || window.webkitURL;
        var bb = new Blob([data], {type: 'text/plain'});
        fileWriter.write(bb);
      }, errorHandler);
    }, errorHandler);
  }, errorHandler);
};


var initFs = function(filesys) {
  window.webagram.fs = filesys;
  setTimeout(initDirectory(window.webagram.fs), 500);
};


var replayVideo = function(idx) {
  // reads through all the images and show them (image path stored in _files)

  switchPanel('replay', 'Video Preview');

  stopRec(); // stop video recording
  //window.webagram.video.style.display = 'none'; // hide 
  window.webagram.replay.style.display = 'block'; // hide the video to see the recording
  idx = parseInt(idx,10) || 0;


  if(window.webagram._files[idx] === undefined) {
    alert('nothing to play');
    return;
  }
  
  var img = window.webagram.replay;

  window.webagram.fs.root.getFile(window.webagram._files[idx], {}, function(fileEntry) {
    fileEntry.file(function(file) {
      var reader = new FileReader();
      reader.onloadend = function(e) {
          img.src = this.result;
          
        if(++idx < window.webagram._files.length) {
          setTimeout(function(){
            replayVideo(idx);
          }, 200);
        }
      };
      reader.readAsText(file);
    }, errorHandler);
  }, errorHandler);
};

function timeStamp() {
// Create a date object with the current time
  var now = new Date();
 
// Create an array with the current month, day and time
  var date = [ now.getMonth() + 1, now.getDate(), now.getFullYear() ];
 
// Create an array with the current hour, minute and second
  var time = [ now.getHours(), now.getMinutes(), now.getSeconds() ];
 
// Determine AM or PM suffix based on the hour
  var suffix = ( time[0] < 12 ) ? "AM" : "PM";
 
// Convert hour from military time
  time[0] = ( time[0] < 12 ) ? time[0] : time[0] - 12;
 
// If hour is 0, set it to 12
  time[0] = time[0] || 12;
 
// If seconds and minutes are less than 10, add a zero
  for ( var i = 1; i < 3; i++ ) {
    if ( time[i] < 10 ) {
      time[i] = "0" + time[i];
    }
  }
 
// Return the formatted string
  return date.join("-") + " " + time.join("-") + " " + suffix;
}


// e.g readFile('/Video/lastvideo')
var readFile = function(filename) {
  window.webagram.fs.root.getFile(filename, {}, function(fileEntry) {
    fileEntry.file(function(file) {
      var reader = new FileReader();
      reader.onloadend = function(e) {


        //var myImage = document.createElement('img');
        //myImage.src = this.result;
        //document.body.appendChild(myImage);


      };
      //reader.readAsText(file);
      reader.readAsDataURL(file);
    }, errorHandler);
  }, errorHandler);
};

  function fallback(e) {
    alert('User Media not supported in your browser');
  }


  window.webagram.gif.on('finished', function(blob) {

    var file = URL.createObjectURL(blob);
    writeToFile('lastvideo', blob);

    var myImage = document.createElement('img');
    myImage.src = file;
    //document.body.appendChild(myImage);
    
  switchPanel('finalgif', 'Final GIF');
  window.webagram.finalgif.appendChild(myImage);


  });

  function makeGif(){
    window.webagram.gif.render();
  }

  function draw(v, bc, w, h) {

      bc.drawImage(v, 0, 0, w, h);
      var stringData=window.webagram.canvas.toDataURL();

      window.webagram.gif.addFrame(window.webagram.canvas, {copy: true});
      
      if(window.webagram.fs !== null) {
        console.log('drawcall', frames);
        writeToFile('frames' + frames++, stringData);
      }
      if(!window.webagram._stop) {
        //200
        setTimeout(function(){ draw(v, bc, w, h); }, 100); // the timeout here decides video rec framerate
      }
  }


  function success(stream) {
    window.webagram.localMediaStream = stream;
    window.webagram.video.src = window.webkitURL.createObjectURL(stream);

    var back = window.webagram.canvas;
    var backcontext = back.getContext('2d');

    cw = 360;
    ch = 240;
    back.width = cw;
    back.height = ch;
    draw(window.webagram.video, backcontext, cw, ch);

  }

  function recordVideo() {
    webagram.video.src = '';
    if (!navigator.getUserMedia) {
      fallback();
    } else {
      navigator.getUserMedia({video: true}, success, fallback);
    }
  }

  function playLast(){
    readFile('/Video/lastvideo');
  }


  document.addEventListener('WebComponentsReady', function() {

   var splash = document.querySelector('.splash');
   var panels = document.querySelectorAll('.panel');
   var itemsView = document.querySelector('pi-items-view');
   var el;

   window.webagram.video = document.querySelector('video');

   window.webagram.canvas = document.querySelector('canvas');

   window.webagram.finalgif = document.getElementById('finalgif');

   window.webagram.replay = document.getElementById('replay-screen');

   window.requestFileSystem  = window.requestFileSystem || window.webkitRequestFileSystem;
window.requestFileSystem(window.TEMPORARY, 10*1024*1024, initFs, errorHandler);


 
    setTimeout(function(){
      splash.style.display = "none";
    }, 2000);


    itemsView.items = [];
    itemsView.items.push({
        title: 'Image.gif', 
        feed: [{
          title: 'Indie Shuffle', 
          feed: 'http://feeds.feedburner.com/indieshuffle'
        }]
      });

      fetchImageForTopics(itemsView.items);
    });

    
    function fetchImageForTopics(inTopics) {
      inTopics.forEach(function(t) {
        t.imgSrc = '';
        var fa = document.createElement('pi-feed-aggregator');
        fa.cancelUnbindAll();
        fa.count = 4;
        fa.addEventListener('response', function(e) {
          var ns = e.detail && e.detail.entries || [];
          for (var i = 0, n; n = ns[i]; i++) {
            if (n.imgSrc) {
              t.imgSrc = n.imgSrc;
              t.unread = 200;
              return;
            }
          }
          fa.unbindAll();
        });
        fa.feed = t.feed;
      });
    }
  </script>

  </section>

</body>
</html>
